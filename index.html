<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Theme Editor - v2.2.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #09090b; color: #f4f4f5; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        .glass-panel { background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(8px); border-right: 1px solid #27272a; }
        .preview-container { background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
        .color-card { background: #18181b; border: 1px solid #27272a; transition: all 0.2s ease; }
        .color-card:hover { border-color: #3f3f46; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; background: none; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid #3f3f46; border-radius: 6px; }
        #drop-zone.drag-over { background-color: rgba(39, 39, 42, 0.8); border-color: #3b82f6; transform: scale(1.02); }
        .modal-overlay { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); z-index: 50; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="h-16 border-b border-zinc-800 flex items-center justify-between px-8 z-10 bg-zinc-950">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
            </div>
            <h1 class="text-lg font-medium tracking-tight">HTML Theme Editor <span class="text-zinc-500 font-normal text-sm">v2.2.4</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <span id="file-name-header" class="text-xs text-zinc-500 italic">No file loaded</span>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <aside class="w-96 glass-panel flex flex-col">
            <div id="drop-zone" class="m-6 p-8 border-2 border-dashed border-zinc-700 rounded-xl flex flex-col items-center justify-center text-center cursor-pointer transition-all hover:border-zinc-500">
                <input type="file" id="file-input" class="hidden" accept=".html,.htm">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-500 mb-2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                <p class="text-sm text-zinc-400">ファイルをドロップ</p>
                <p class="text-xs text-zinc-600 mt-1">またはクリックして選択</p>
                <button id="load-sample-btn" class="mt-4 text-[11px] text-blue-400 hover:text-blue-300 underline underline-offset-4">動作確認用のサンプルを読み込む</button>
            </div>

            <div id="theme-selector" class="hidden mx-6 mb-4">
                <label class="text-xs font-bold text-zinc-500 uppercase tracking-widest block mb-2">編集するテーマを選択</label>
                <select id="theme-select" class="w-full bg-zinc-900 border border-zinc-700 rounded-lg px-3 py-2 text-sm text-zinc-300 focus:outline-none focus:border-blue-600">
                </select>
            </div>

            <div class="flex-1 overflow-y-auto px-6 pb-6 space-y-8">
                <section>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xs font-bold text-zinc-500 uppercase tracking-widest">CSS Variables</h2>
                        <div class="flex gap-2">
                            <button id="reset-all-btn" class="hidden text-[10px] bg-amber-600/10 hover:bg-amber-600/20 text-amber-400 border border-amber-600/30 px-2 py-1 rounded transition-colors">
                                すべて戻す
                            </button>
                            <button id="import-trigger-btn" class="hidden text-[10px] bg-blue-600/10 hover:bg-blue-600/20 text-blue-400 border border-blue-600/30 px-2 py-1 rounded transition-colors">
                                インポート
                            </button>
                        </div>
                    </div>
                    <div id="variable-list" class="space-y-3 text-center py-10 text-zinc-600 text-sm italic">
                        ファイルを読み込んでください
                    </div>
                </section>
            </div>
        </aside>

        <div class="flex-1 bg-zinc-900 p-8 flex flex-col">
            <div class="mb-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-zinc-500 font-medium tracking-wide uppercase">Preview</span>
                    <span id="file-name-display" class="text-xs bg-zinc-800 text-zinc-400 px-2 py-0.5 rounded">---</span>
                </div>
                <div id="action-buttons" class="flex gap-2 opacity-30 pointer-events-none transition-opacity duration-300">
                    <button id="copy-palette-btn" class="flex items-center gap-2 px-4 py-1.5 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded text-xs font-medium transition-colors">パレットをコピー</button>
                    <button id="download-btn" class="flex items-center gap-2 px-4 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs font-medium transition-colors shadow-lg shadow-blue-900/20">HTMLファイルを保存</button>
                </div>
            </div>
            <div class="preview-container flex-1 bg-white relative">
                <iframe id="preview-iframe" class="w-full h-full border-none" sandbox="allow-scripts allow-same-origin"></iframe>
                <div id="preview-overlay" class="absolute inset-0 bg-zinc-950 flex items-center justify-center transition-opacity duration-500">
                    <p class="text-zinc-600 text-sm tracking-widest uppercase">No Preview Content</p>
                </div>
            </div>
        </div>
    </main>

    <div id="import-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4">
        <div class="bg-zinc-900 border border-zinc-800 w-full max-w-xl rounded-xl shadow-2xl flex flex-col">
            <div class="p-6 border-b border-zinc-800 flex justify-between items-center">
                <h3 class="text-lg font-medium">パレットをインポート</h3>
                <button id="close-modal-btn" class="text-zinc-500 hover:text-white text-xl">×</button>
            </div>
            <div class="p-6">
                <textarea id="import-textarea" class="w-full h-64 bg-zinc-950 border border-zinc-800 rounded-lg p-4 font-mono text-sm text-zinc-300 focus:outline-none focus:border-blue-600" placeholder=":root { --primary: #000; }"></textarea>
            </div>
            <div class="p-6 bg-zinc-950/50 flex justify-end gap-3">
                <button id="apply-import-btn" class="px-6 py-2 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-500 transition-colors">適用</button>
            </div>
        </div>
    </div>

    <textarea id="copy-buffer" class="fixed opacity-0 pointer-events-none"></textarea>
    <div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-2"></div>

    <script>
        let originalHtml = "";
        let currentVariables = {}; 
        let currentFileName = "updated_file.html";
        let detectedThemes = [];
        let currentThemeKey = null;
        let extractionMethod = null;

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const variableList = document.getElementById('variable-list');
        const previewIframe = document.getElementById('preview-iframe');
        const previewOverlay = document.getElementById('preview-overlay');
        const actionButtons = document.getElementById('action-buttons');
        const importTriggerBtn = document.getElementById('import-trigger-btn');
        const resetAllBtn = document.getElementById('reset-all-btn');
        const themeSelector = document.getElementById('theme-selector');
        const themeSelect = document.getElementById('theme-select');
        const fileNameDisplay = document.getElementById('file-name-display');
        const fileNameHeader = document.getElementById('file-name-header');
        const importModal = document.getElementById('import-modal');
        const importTextarea = document.getElementById('import-textarea');
        const applyImportBtn = document.getElementById('apply-import-btn');
        const copyBuffer = document.getElementById('copy-buffer');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); });
        
        function handleFile(file) {
            currentFileName = file.name;
            const reader = new FileReader();
            reader.onload = e => processHtmlContent(e.target.result);
            reader.readAsText(file);
        }

        function processHtmlContent(html) {
            originalHtml = html;
            currentVariables = {};
            detectedThemes = [];
            themeSelector.classList.add('hidden');

            const jsThemes = extractJavaScriptThemes(html);
            if (jsThemes && jsThemes.length > 0) {
                detectedThemes = jsThemes;
                extractionMethod = 'js';
                showThemeSelector(jsThemes);
            } else {
                const cssVars = extractCssRootVariables(html);
                if (Object.keys(cssVars).length > 0) {
                    currentVariables = cssVars;
                    extractionMethod = 'css';
                    refreshUI();
                } else {
                    variableList.innerHTML = `<div class="text-center py-10 text-zinc-600 text-sm italic">CSS変数が見つかりませんでした</div>`;
                    showToast("CSS変数が見つかりませんでした", "error");
                }
            }
        }

        function extractJavaScriptThemes(html) {
            const themes = [];
            const themesPattern = /const\s+THEMES\s*=\s*(\{[\s\S]*?\n\s*\});/;
            const match = html.match(themesPattern);
            if (!match) return null;
            
            const themesBlock = match[1];
            // 改良版：行単位ではなく、より確実に「テーマのまとまり」を抽出
            // キー名: { ... vars: { ... } } を探す
            const themeRegex = /(\w+):\s*\{[\s\S]*?name:\s*(['"])(.*?)\2[\s\S]*?vars:\s*\{([\s\S]*?)\}/g;
            let m;
            while ((m = themeRegex.exec(themesBlock)) !== null) {
                const key = m[1];
                const name = m[3];
                const varsContent = m[4];
                
                const variables = {};
                // 変数名が -- で始まるものだけを抽出
                const varPattern = /(['"]?)(--[\w-]+)\1\s*:\s*(['"])([^'"]+)\3/g;
                let v;
                while ((v = varPattern.exec(varsContent)) !== null) {
                    variables[v[2]] = { value: v[4], original: v[4] };
                }
                
                if (Object.keys(variables).length > 0) {
                    themes.push({ key, name, variables });
                }
            }
            return themes;
        }

        function extractCssRootVariables(html) {
            const variables = {};
            const varRegex = /(--[\w-]+)\s*:\s*([^;?]+?)(?=;|})/g;
            let match;
            while ((match = varRegex.exec(html)) !== null) {
                const name = match[1].trim(), value = match[2].trim();
                if (/^#|rgb|hsl/.test(value)) variables[name] = { value, original: value };
            }
            return variables;
        }

        function showThemeSelector(themes) {
            themeSelect.innerHTML = '<option value="">選択してください</option>';
            themes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.key; opt.textContent = t.name;
                themeSelect.appendChild(opt);
            });
            themeSelector.classList.remove('hidden');
            themeSelect.onchange = (e) => {
                const selected = themes.find(t => t.key === e.target.value);
                if (selected) {
                    currentThemeKey = selected.key;
                    currentVariables = JSON.parse(JSON.stringify(selected.variables));
                    refreshUI();
                }
            };
        }

        function refreshUI() {
            renderVariableEditor();
            setupPreview(originalHtml);
            previewOverlay.classList.add('hidden');
            actionButtons.classList.remove('opacity-30', 'pointer-events-none');
            importTriggerBtn.classList.remove('hidden');
            resetAllBtn.classList.remove('hidden');
            fileNameDisplay.textContent = currentFileName;
            fileNameHeader.textContent = currentFileName;
            showToast("テーマを読み込みました");
        }

        function renderVariableEditor() {
            variableList.innerHTML = '';
            Object.entries(currentVariables).forEach(([name, data]) => {
                const card = document.createElement('div');
                card.className = 'color-card p-4 rounded-lg flex flex-col gap-3';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="overflow-hidden mr-2 flex-1 text-left">
                            <div class="text-[10px] text-zinc-500 font-bold uppercase truncate">${name}</div>
                            <div class="text-xs text-zinc-300 font-mono">${data.value}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="resetSingleVariable('${name}')" class="p-1.5 rounded hover:bg-zinc-700 text-zinc-500 hover:text-amber-400 transition-colors" title="元に戻す">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                            </button>
                            <input type="color" value="${convertToHex(data.value)}" oninput="updateVariable('${name}', this.value)">
                        </div>
                    </div>
                `;
                variableList.appendChild(card);
            });
        }

        function resetSingleVariable(name) {
            if (currentVariables[name]) {
                currentVariables[name].value = currentVariables[name].original;
                renderVariableEditor();
                applyStylesToPreview();
                showToast(`${name} を元に戻しました`);
            }
        }

        resetAllBtn.onclick = () => {
            Object.values(currentVariables).forEach(v => v.value = v.original);
            renderVariableEditor();
            applyStylesToPreview();
            showToast("すべて初期値に戻しました");
        };

        function updateVariable(name, val) {
            currentVariables[name].value = val;
            applyStylesToPreview();
            // リアルタイム反映のために、表示されている16進数テキストも更新
            const cards = variableList.querySelectorAll('.color-card');
            cards.forEach(card => {
                if (card.querySelector('.uppercase').textContent === name) {
                    card.querySelector('.font-mono').textContent = val;
                }
            });
        }

        function applyStylesToPreview() {
            let css = ':root {';
            Object.entries(currentVariables).forEach(([name, data]) => css += `${name}: ${data.value} !important;`);
            css += '}';
            if (previewIframe.contentWindow) previewIframe.contentWindow.postMessage({ type: 'UPDATE_STYLES', css }, '*');
        }

        function setupPreview(html) {
            const injector = `<script>window.addEventListener('message', e => { if (e.data.type === 'UPDATE_STYLES') { let s = document.getElementById('inj'); if(!s){s=document.createElement('style');s.id='inj';document.head.appendChild(s);} s.textContent = e.data.css; } });<\/script>`;
            let content = html.includes('<head>') ? html.replace('<head>', '<head>' + injector) : injector + html;
            previewIframe.src = URL.createObjectURL(new Blob([content], { type: 'text/html;charset=utf-8' }));
            previewIframe.onload = () => setTimeout(applyStylesToPreview, 500);
        }

        function convertToHex(s) {
            if(s.startsWith('#')) return s;
            const ctx = document.createElement('canvas').getContext('2d');
            ctx.fillStyle = s; return ctx.fillStyle;
        }

        function showToast(m, t="success") {
            const toast = document.createElement('div');
            toast.className = `bg-zinc-800 text-xs text-white px-4 py-3 rounded-lg border border-zinc-700 shadow-xl transition-all flex items-center gap-2`;
            toast.innerHTML = `<div class="w-1.5 h-1.5 rounded-full ${t==='success'?'bg-blue-500':'bg-red-500'}"></div>${m}`;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-x-10'); setTimeout(() => toast.remove(), 500); }, 3000);
        }

        document.getElementById('copy-palette-btn').onclick = () => {
            let css = `:root {\n`; Object.entries(currentVariables).forEach(([n, d]) => css += `  ${n}: ${d.value};\n`); css += `}`;
            copyBuffer.value = css; copyBuffer.select(); document.execCommand('copy'); showToast("コピーしました");
        };

        document.getElementById('download-btn').onclick = () => {
            let final = originalHtml;
            if (extractionMethod === 'js' && currentThemeKey) {
                const themeBlockPattern = new RegExp(`(${currentThemeKey}:\\s*\\{[\\s\\S]*?vars:\\s*\\{)([\\s\\S]*?)(\\n\\s*\\})`, 'g');
                final = final.replace(themeBlockPattern, (match, before, oldVars, after) => {
                    let newVars = '\n';
                    Object.entries(currentVariables).forEach(([name, data]) => newVars += `                    '${name}': '${data.value}',\n`);
                    return before + newVars + after;
                });
            } else {
                let rootCss = `:root {\n`; Object.entries(currentVariables).forEach(([n, d]) => rootCss += `  ${n}: ${d.value};\n`); rootCss += `}`;
                final = final.match(/:root\s*\{[\s\S]*?\}/) ? final.replace(/:root\s*\{[\s\S]*?\}/, rootCss) : final.replace('</head>', `<style>\n${rootCss}\n</style>\n</head>`);
            }
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([final], { type: 'text/html;charset=utf-8' }));
            a.download = currentFileName.replace(/\.(html?)$/i, '_edited.$1');
            a.click();
        };

        document.getElementById('close-modal-btn').onclick = () => importModal.classList.add('hidden');
        document.getElementById('import-trigger-btn').onclick = () => importModal.classList.remove('hidden');

        document.getElementById('load-sample-btn').onclick = (e) => {
            e.stopPropagation();
            const sample = `<!DOCTYPE html><html><head><style>:root { --bg: #ffffff; --text: #1f2937; --primary: #3b82f6; } body { background: var(--bg); color: var(--text); padding: 2rem; font-family: sans-serif; } .card { border: 2px solid var(--primary); padding: 1rem; border-radius: 8px; }</style></head><body><div class="card"><h1>Sample</h1><p>色の変更を試せます。</p></div></body></html>`;
            currentFileName = "sample.html";
            processHtmlContent(sample);
        };
    </script>
</body>
</html>
